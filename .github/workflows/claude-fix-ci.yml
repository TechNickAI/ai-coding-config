name: Claude Fix CI

on:
  workflow_run:
    workflows: ["CI"] # Replace "CI" with your actual CI workflow name
    types: [completed]
    branches: [main, develop]
  workflow_dispatch:

jobs:
  fix-ci:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      actions: read

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Run Claude Code to Fix CI Issues
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            This PR has failing CI checks. Please:

            1. Examine the CI failures
            2. Fix the issues (linting errors, test failures, type errors, etc.)
            3. Commit the fixes with a clear message

            Use the project's coding standards from .cursor/rules/ if available.
            Run tests to verify fixes work before committing.

          claude_args:
            '--permission-mode bypassPermissions --allowed-tools
            "Bash(*),Read(*),Write(*),Edit(*)"'

      - name: Push fixes if any were made
        run: |
          if git diff --quiet; then
            echo "No changes made"
          else
            git push
            echo "Pushed fixes to PR"
          fi
