---
description: When writing Celery tasks
globs: **/tasks.py
alwaysApply: false
---

# Celery Task Structure

## Task Definition

```python
@shared_task(max_retries=3, default_retry_delay=60)
def process_order(order_id: int):
    """Process order and send confirmation email."""
    logger.info(f"Processing order {order_id}")
    order = Order.objects.get(id=order_id)
    order.process_payment()
    send_confirmation_email(order)
    logger.info(f"Order {order_id} complete")
    return {"status": "success", "order_id": order_id}

@shared_task(rate_limit="10/m")
def sync_inventory(product_id: int):
    """Sync product inventory from external API."""
    product = Product.objects.get(id=product_id)
    inventory_data = fetch_inventory_from_api(product.sku)
    product.stock_count = inventory_data["quantity"]
    product.save()
    return {"product_id": product_id, "stock": product.stock_count}

@shared_task
def generate_daily_report(date: str):
    """Generate and email daily sales report."""
    report_date = datetime.fromisoformat(date)
    report = compile_sales_report(report_date)
    send_report_email(report)
    return {"date": date, "orders": report.order_count}
```

## Best Practices

- Use type hints for parameters
- Include comprehensive docstrings
- Log start and completion
- Use appropriate retry settings
- Consider rate limits for external APIs
- Pass IDs, not objects (objects can't be serialized)
- Return serializable data (dicts, not model instances)

## Error Handling

```python
@shared_task(max_retries=3, default_retry_delay=60)
def risky_operation(data_id: int):
    """Operation that might fail and should retry"""
    try:
        data = Data.objects.get(id=data_id)
        result = external_api_call(data)
        return result
    except ExternalAPIError as exc:
        # Retry on API errors
        logger.warning(f"API error, will retry: {exc}")
        raise self.retry(exc=exc)
    except Data.DoesNotExist:
        # Don't retry on data errors
        logger.error(f"Data {data_id} not found")
        return None
```

## Task Organization

- Group related tasks in the same file
- Use clear, action-oriented names: `update_`, `process_`, `sync_`
- Keep tasks focused - one clear responsibility
- Extract complex logic into helper functions

## Testing

- Mock external dependencies
- Test task logic, not Celery internals
- Test retry behavior for expected failures
- Verify logging outputs
